<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cloudflare æœ¬åœ°æ‰“ç çœ‹æ¿</title>
    <link rel="icon" href="https://dash.cloudflare.com/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><img src="https://dash.cloudflare.com/favicon.ico" alt="Cloudflare" style="width: 40px; height: 40px; vertical-align: middle; margin-right: 10px;">Cloudflare æœ¬åœ°æ‰“ç çœ‹æ¿</h1>
        </div>

        <div class="dashboard">
            <!-- æœåŠ¡çŠ¶æ€å¡ç‰‡ -->
            <div class="card">
                <h3><span class="icon">ğŸŸ¢</span>æœåŠ¡çŠ¶æ€</h3>
                <div id="serviceStatus" class="loading">åŠ è½½ä¸­...</div>
            </div>

            <!-- å®ä¾‹ä¿¡æ¯å¡ç‰‡ -->
            <div class="card">
                <h3><span class="icon">ğŸ–¥ï¸</span>å®ä¾‹ä¿¡æ¯</h3>
                <div id="instanceInfo" class="loading">åŠ è½½ä¸­...</div>
            </div>

            <!-- è¯·æ±‚ç»Ÿè®¡å¡ç‰‡ -->
            <div class="card">
                <h3><span class="icon">ğŸ“Š</span>è¯·æ±‚ç»Ÿè®¡</h3>
                <div id="requestStats" class="loading">åŠ è½½ä¸­...</div>
            </div>

            <!-- å†…å­˜ä¿¡æ¯å¡ç‰‡ -->
            <div class="card">
                <h3><span class="icon">ğŸ’¾</span>å†…å­˜ä¿¡æ¯</h3>
                <div id="memoryInfo" class="loading">åŠ è½½ä¸­...</div>
            </div>

            <!-- è´Ÿè½½å†å²å›¾è¡¨ -->
            <div class="card load-history-card" style="grid-column: 1 / -1;">
                <h3>
                    <span class="icon">ğŸ“Š</span>è´Ÿè½½å†å²
                    <span class="live-indicator">å®æ—¶ 1s</span>
                </h3>
                <div class="metrics-summary" id="metricsSummary" style="display: flex; gap: 20px; margin-bottom: 10px; flex-wrap: wrap;">
                    <div class="metric-item">
                        <span class="metric-label">å½“å‰æ´»è·ƒ</span>
                        <span class="metric-value" id="currentActive">0</span>
                    </div>
                    <div class="metric-item">
                        <span class="metric-label">å³°å€¼å¹¶å‘</span>
                        <span class="metric-value" id="peakConcurrent">0</span>
                    </div>
                    <div class="metric-item">
                        <span class="metric-label">å¹³å‡è´Ÿè½½</span>
                        <span class="metric-value" id="avgLoad">0.0</span>
                    </div>
                    <div class="metric-item">
                        <span class="metric-label">æ€»å®¹é‡</span>
                        <span class="metric-value" id="totalCapacity">100</span>
                    </div>
                </div>
                <div class="chart-container load-chart-container">
                    <canvas id="loadHistoryChart" class="chart-canvas"></canvas>
                </div>
            </div>
        </div>

        <!-- è¯·æ±‚å†å²ä¸å®æ—¶çŠ¶æ€ -->
        <div class="table-container">
            <h3>
                <span class="icon">ğŸ“‹</span>è¯·æ±‚è®°å½•ä¸å®æ—¶çŠ¶æ€ 
                <button class="btn" onclick="resetMonitorData()">é‡ç½®æ•°æ®</button>
                <span class="live-indicator">å®æ—¶æ›´æ–°</span>
            </h3>
            <div id="unifiedRequestTable" class="loading">åŠ è½½ä¸­...</div>
        </div>

        <div class="footer">
            <div style="display: flex; justify-content: center; align-items: center; gap: 30px;">
                <span>
                    Designed by <a href="https://x.com/Johnze268" target="_blank">
                        <img src="https://abs.twimg.com/favicons/twitter.2.ico" alt="Twitter"> 0xsongsu
                    </a>
                </span>
                <span>
                    Powered by <a href="https://claude.ai" target="_blank">
                        <img src="https://claude.ai/favicon.ico" alt="Claude">
                    </a>
                </span>
            </div>
        </div>
    </div>

    <script src="charts.js"></script>
    <script>
        let updateInterval;
        let loadChart = null;
        let loadHistory = [];
        let peakConcurrent = 0;
        
        // åˆå§‹åŒ–å›¾è¡¨
        function initCharts() {
            const canvas = document.getElementById('loadHistoryChart');
            if (canvas) {
                loadChart = new LoadHistoryChart(canvas, {
                    backgroundColor: '#f8f9fa',
                    fillColor: 'rgba(52, 144, 220, 0.2)',
                    lineColor: 'rgba(52, 144, 220, 1)',
                    lineWidth: 2,
                    maxDataPoints: 60
                });
            }
        }

        // æ ¼å¼åŒ–æ—¶é—´
        function formatTime(timestamp) {
            return new Date(timestamp).toLocaleString('zh-CN');
        }

        // æ ¼å¼åŒ–æŒç»­æ—¶é—´
        function formatDuration(ms) {
            if (ms < 1000) return `${ms}ms`;
            if (ms < 60000) return `${(ms / 1000).toFixed(1)}s`;
            if (ms < 3600000) return `${(ms / 60000).toFixed(1)}m`;
            return `${(ms / 3600000).toFixed(1)}h`;
        }

        // æ ¼å¼åŒ–å†…å­˜å¤§å°
        function formatMemory(mb) {
            if (mb < 1024) return `${mb}MB`;
            return `${(mb / 1024).toFixed(1)}GB`;
        }

        // è·å–ç›‘æ§æ•°æ®
        async function fetchMonitorData() {
            try {
                let response = await fetch('/api/monitor');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                updateDashboard(data);
                
            } catch (error) {
                console.error('è·å–ç›‘æ§æ•°æ®å¤±è´¥:', error);
                showError('è·å–ç›‘æ§æ•°æ®å¤±è´¥: ' + error.message);
            }
        }

        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.textContent = message;
            
            // åœ¨æ¯ä¸ªloadingå…ƒç´ ä¸­æ˜¾ç¤ºé”™è¯¯
            document.querySelectorAll('.loading').forEach(element => {
                element.innerHTML = '';
                element.appendChild(errorDiv.cloneNode(true));
            });
        }

        // æ›´æ–°ä»ªè¡¨æ¿
        function updateDashboard(data) {
            updateServiceStatus(data);
            updateInstanceInfo(data);
            updateRequestStats(data);
            updateMemoryInfo(data);
            updateUnifiedRequestTable(data);
            updateLoadMetrics(data);
            updateCharts(data);
        }

        // æ›´æ–°æœåŠ¡çŠ¶æ€
        function updateServiceStatus(data) {
            const element = document.getElementById('serviceStatus');
            const uptime = formatDuration(data.uptime);
            const startTime = formatTime(data.startTime);
            
            element.innerHTML = `
                <div class="stat-grid">
                    <div class="stat-item">
                        <div class="stat-value">
                            <span class="status-indicator status-running"></span>
                            è¿è¡Œä¸­
                        </div>
                        <div class="stat-label">æœåŠ¡çŠ¶æ€</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${uptime}</div>
                        <div class="stat-label">è¿è¡Œæ—¶é—´</div>
                    </div>
                </div>
                <div style="margin-top: 10px; font-size: 0.9rem; color: #7f8c8d;">
                    å¯åŠ¨æ—¶é—´: ${startTime}
                </div>
            `;
        }

        // æ›´æ–°å®ä¾‹ä¿¡æ¯
        function updateInstanceInfo(data) {
            const element = document.getElementById('instanceInfo');
            const usagePercent = data.instances.total > 0 ? 
                (data.instances.active / data.instances.total * 100).toFixed(1) : 0;
            
            let instanceDetailsHtml = '';
            
            // æ˜¾ç¤ºå„ä¸ªå®¹å™¨çš„è¯¦ç»†ä¿¡æ¯ï¼ˆå¦‚æœæœ‰å¤šå®¹å™¨éƒ¨ç½²ï¼‰
            if (data.containers && data.containers.length > 0) {
                instanceDetailsHtml = `
                    <div style="margin-top: 15px; border-top: 1px solid rgba(0,0,0,0.1); padding-top: 15px;">
                        <h4 style="margin: 0 0 10px 0; font-size: 0.9rem; color: #34495e;">å®¹å™¨è¯¦æƒ…</h4>
                        ${data.containers.map(container => `
                            <div style="margin-bottom: 8px; padding: 8px; background: rgba(255,255,255,0.5); border-radius: 4px; font-size: 0.8rem;">
                                <strong>${container.host}</strong>
                                <span style="float: right;">
                                    <span class="status-indicator status-running"></span>
                                    ${container.instances.total}å®ä¾‹ (${container.instances.active}æ´»è·ƒ/${container.instances.available}ç©ºé—²)
                                </span>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            // æ˜¾ç¤ºæµè§ˆå™¨å®ä¾‹æ± è¯¦æƒ…
            let browserPoolHtml = '';
            if (data.browserPoolDetails && data.browserPoolDetails.length > 0) {
                browserPoolHtml = `
                    <div style="margin-top: 15px; border-top: 1px solid rgba(0,0,0,0.1); padding-top: 15px;">
                        <h4 style="margin: 0 0 10px 0; font-size: 0.9rem; color: #34495e;">æµè§ˆå™¨å®ä¾‹æ± </h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 8px;">
                            ${data.browserPoolDetails.map(instance => `
                                <div style="padding: 8px; background: rgba(255,255,255,0.5); border-radius: 4px; text-align: center; font-size: 0.75rem;">
                                    <div style="font-weight: bold;">å®ä¾‹ #${instance.id}</div>
                                    <div style="margin: 2px 0;">
                                        <span class="status-indicator ${instance.status === 'idle' ? 'status-running' : 'status-warning'}"></span>
                                        ${instance.status === 'idle' ? 'ç©ºé—²' : 'å¿™ç¢Œ'}
                                    </div>
                                    <div style="color: #7f8c8d; font-size: 0.7rem;">
                                        ä¸Šä¸‹æ–‡: ${instance.contexts || 0}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            element.innerHTML = `
                <div class="stat-grid">
                    <div class="stat-item">
                        <div class="stat-value">${data.instances.total}</div>
                        <div class="stat-label">æ€»å®ä¾‹æ•°</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${data.instances.active}</div>
                        <div class="stat-label">å¿™ç¢Œå®ä¾‹</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${data.instances.available}</div>
                        <div class="stat-label">ç©ºé—²å®ä¾‹</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${data.browserContexts || 0}</div>
                        <div class="stat-label">æµè§ˆå™¨å®ä¾‹</div>
                    </div>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: ${usagePercent}%"></div>
                </div>
                <div style="text-align: center; margin-top: 5px; font-size: 0.9rem; color: #7f8c8d;">
                    ä½¿ç”¨ç‡: ${usagePercent}%
                </div>
                ${instanceDetailsHtml}
                ${browserPoolHtml}
            `;
        }

        // æ›´æ–°è¯·æ±‚ç»Ÿè®¡
        function updateRequestStats(data) {
            const element = document.getElementById('requestStats');
            
            element.innerHTML = `
                <div class="stat-grid">
                    <div class="stat-item">
                        <div class="stat-value">${data.requests.total}</div>
                        <div class="stat-label">æ€»è¯·æ±‚æ•°</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${data.requests.successful}</div>
                        <div class="stat-label">æˆåŠŸè¯·æ±‚</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${data.requests.failed}</div>
                        <div class="stat-label">å¤±è´¥è¯·æ±‚</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${data.requests.active}</div>
                        <div class="stat-label">æ´»è·ƒè¯·æ±‚</div>
                    </div>
                </div>
                <div style="text-align: center; margin-top: 10px;">
                    <strong>æˆåŠŸç‡: ${data.requests.successRate}%</strong>
                </div>
            `;
        }

        // æ›´æ–°å†…å­˜ä¿¡æ¯
        function updateMemoryInfo(data) {
            const element = document.getElementById('memoryInfo');
            const memory = data.memory;
            
            element.innerHTML = `
                <div class="stat-grid">
                    <div class="stat-item">
                        <div class="stat-value">${memory.process.heapUsed}</div>
                        <div class="stat-label">å †å†…å­˜ä½¿ç”¨</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${memory.process.rss}</div>
                        <div class="stat-label">RSSå†…å­˜</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${formatMemory(memory.system.used)}</div>
                        <div class="stat-label">ç³»ç»Ÿå·²ç”¨</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${formatMemory(memory.system.free)}</div>
                        <div class="stat-label">ç³»ç»Ÿå¯ç”¨</div>
                    </div>
                </div>
            `;
        }

        // æˆªæ–­tokenæ˜¾ç¤º
        function truncateToken(token, maxLength = 30) {
            if (!token || token.length <= maxLength) return token || '';
            return token.substring(0, maxLength) + '...';
        }

        // æ›´æ–°ç»Ÿä¸€è¯·æ±‚è¡¨æ ¼
        function updateUnifiedRequestTable(data) {
            const element = document.getElementById('unifiedRequestTable');
            const allRequests = [];
            
            // æ·»åŠ æ´»è·ƒè¯·æ±‚ï¼ˆå¤„ç†ä¸­çŠ¶æ€ï¼‰
            data.activeRequests.forEach(req => {
                allRequests.push({
                    timestamp: req.startTime,
                    url: req.url,
                    mode: req.mode,
                    status: 'processing',
                    token: '',
                    responseTime: Date.now() - new Date(req.startTime).getTime(),
                    isActive: true,
                    requestId: req.id,
                    clientIP: req.clientIP
                });
            });
            
            // æ·»åŠ è¯·æ±‚å†å²ï¼ˆå·²å®Œæˆ/å¤±è´¥çŠ¶æ€ï¼‰
            data.requestHistory.forEach(req => {
                // æŸ¥æ‰¾å¯¹åº”çš„token
                const matchingToken = data.recentTokens.find(token => 
                    token.requestId === req.requestId || 
                    (token.url === req.url && Math.abs(new Date(token.timestamp).getTime() - new Date(req.timestamp).getTime()) < 5000)
                );
                
                allRequests.push({
                    timestamp: req.timestamp,
                    url: req.url,
                    mode: req.mode,
                    status: req.success ? 'completed' : 'failed',
                    token: matchingToken ? matchingToken.token : '',
                    responseTime: req.responseTime,
                    isActive: false,
                    requestId: req.requestId
                });
            });
            
            // æŒ‰æ—¶é—´å€’åºæ’åˆ—
            allRequests.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            if (allRequests.length === 0) {
                element.innerHTML = '<p style="text-align: center; color: #7f8c8d; padding: 20px;">æš‚æ— è¯·æ±‚è®°å½•</p>';
                return;
            }
            
            const tableHTML = `
                <table>
                    <thead>
                        <tr>
                            <th style="width: 140px;">æ—¶é—´</th>
                            <th style="min-width: 200px;">URL</th>
                            <th style="width: 80px;">çŠ¶æ€</th>
                            <th style="width: 120px;">Token</th>
                            <th style="width: 100px;">å“åº”æ—¶é—´</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${allRequests.slice(0, 50).map(req => {
                            let statusDisplay = '';
                            let statusClass = '';
                            
                            switch(req.status) {
                                case 'processing':
                                    statusDisplay = 'å¤„ç†ä¸­';
                                    statusClass = 'status-warning';
                                    break;
                                case 'completed':
                                    statusDisplay = 'å·²å®Œæˆ';
                                    statusClass = 'status-running';
                                    break;
                                case 'failed':
                                    statusDisplay = 'å¤±è´¥';
                                    statusClass = 'status-error';
                                    break;
                            }
                            
                            const truncatedToken = truncateToken(req.token, 20);
                            const responseTimeDisplay = req.status === 'processing' 
                                ? `${formatDuration(req.responseTime)} â±ï¸`
                                : formatDuration(req.responseTime);
                            
                            return `
                                <tr class="${req.isActive ? 'active-request' : ''}" style="${req.isActive ? 'background-color: rgba(255, 193, 7, 0.1);' : ''}">
                                    <td style="font-size: 0.85rem;">${formatTime(req.timestamp).replace(/:\d{2}$/, '')}</td>
                                    <td style="max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${req.url}">
                                        ${req.url}
                                    </td>
                                    <td>
                                        <span class="status-badge ${statusClass}">${statusDisplay}</span>
                                    </td>
                                    <td style="font-family: monospace; font-size: 0.75rem;" title="${req.token}">
                                        ${truncatedToken ? `<span style="background: #f8f9fa; padding: 2px 4px; border-radius: 3px; border: 1px solid #dee2e6;">${truncatedToken}</span>` : '-'}
                                    </td>
                                    <td style="font-weight: ${req.isActive ? 'bold' : 'normal'};">
                                        ${responseTimeDisplay}
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
                <div style="margin-top: 10px; font-size: 0.85rem; color: #6c757d; text-align: center;">
                    æ˜¾ç¤ºæœ€è¿‘ ${Math.min(allRequests.length, 50)} æ¡è®°å½•
                    ${allRequests.length > 50 ? `ï¼ˆå…± ${allRequests.length} æ¡ï¼‰` : ''}
                </div>
            `;
            
            element.innerHTML = tableHTML;
        }

        // é‡ç½®ç›‘æ§æ•°æ®
        async function resetMonitorData() {
            if (!confirm('ç¡®å®šè¦é‡ç½®æ‰€æœ‰ç›‘æ§æ•°æ®å—ï¼Ÿ')) return;
            
            try {
                const response = await fetch('/api/monitor/reset', { method: 'POST' });
                if (response.ok) {
                    // é‡ç½®æœ¬åœ°æ•°æ®
                    loadHistory = [];
                    peakConcurrent = 0;
                    if (loadChart) {
                        loadChart.clear();
                    }
                    alert('ç›‘æ§æ•°æ®å·²é‡ç½®');
                    fetchMonitorData();
                } else {
                    throw new Error('é‡ç½®å¤±è´¥');
                }
            } catch (error) {
                alert('é‡ç½®å¤±è´¥: ' + error.message);
            }
        }

        // å¯åŠ¨ç›‘æ§
        function startMonitoring() {
            fetchMonitorData(); // ç«‹å³è·å–ä¸€æ¬¡æ•°æ®
            updateInterval = setInterval(fetchMonitorData, 1000); // æ¯1ç§’æ›´æ–°ä¸€æ¬¡
        }

        // åœæ­¢ç›‘æ§
        function stopMonitoring() {
            if (updateInterval) {
                clearInterval(updateInterval);
                updateInterval = null;
            }
        }

        // æ›´æ–°è´Ÿè½½æŒ‡æ ‡
        function updateLoadMetrics(data) {
            const currentActive = data.requests.active;
            const totalCapacity = data.instances.total;
            
            // æ›´æ–°å³°å€¼å¹¶å‘
            peakConcurrent = Math.max(peakConcurrent, currentActive);
            
            // è®°å½•è´Ÿè½½å†å²
            loadHistory.push(currentActive);
            if (loadHistory.length > 60) {
                loadHistory.shift();
            }
            
            // è®¡ç®—å¹³å‡è´Ÿè½½
            const avgLoad = loadHistory.length > 0 ? 
                loadHistory.reduce((sum, val) => sum + val, 0) / loadHistory.length : 0;
            
            // æ›´æ–°æ±‡æ€»æŒ‡æ ‡
            document.getElementById('currentActive').textContent = currentActive;
            document.getElementById('peakConcurrent').textContent = peakConcurrent;
            document.getElementById('avgLoad').textContent = avgLoad.toFixed(1);
            document.getElementById('totalCapacity').textContent = totalCapacity;
        }
        
        // æ›´æ–°å›¾è¡¨
        function updateCharts(data) {
            if (loadChart) {
                const currentActive = data.requests.active;
                const now = new Date();
                loadChart.addData(currentActive, now);
            }
        }
        
        // é¡µé¢åŠ è½½å®Œæˆåå¯åŠ¨ç›‘æ§
        document.addEventListener('DOMContentLoaded', () => {
            // å»¶è¿Ÿåˆå§‹åŒ–å›¾è¡¨ï¼Œç¡®ä¿DOMå®Œå…¨æ¸²æŸ“
            setTimeout(() => {
                initCharts();
                startMonitoring();
            }, 100);
        });

        // çª—å£å¤§å°è°ƒæ•´æ—¶é‡æ–°è°ƒæ•´å›¾è¡¨
        window.addEventListener('resize', () => {
            if (loadChart) {
                loadChart.resize();
            }
        });

        // é¡µé¢ç¦»å¼€æ—¶åœæ­¢ç›‘æ§
        window.addEventListener('beforeunload', stopMonitoring);
        
        // é¡µé¢å¯è§æ€§å˜åŒ–æ—¶æ§åˆ¶ç›‘æ§
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                stopMonitoring();
            } else {
                startMonitoring();
            }
        });
    </script>
</body>
</html>